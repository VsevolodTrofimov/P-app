Search._.template={course:loads.get("Elements/card/course/exports.html"),test:loads.get("Elements/card/test/extended/exports.html"),material:loads.get("Elements/card/material/extended/exports.html"),user:loads.get("Elements/card/user/extended/exports.html")},Search._.build={},Search._.build.num_form=function(e,t){if(0===e)return t.many;if(e%100-e%10!=10){if(e%10===0)return t.many;if(e%10===1)return t.one;if(e%10<=4)return t.few}return t.many},Search._.build.course=function(e){var t=$(search.template.course),n="",i="";return t.find(".__heading").text(e.name),t.find(".__content").html(""),e.is_closed&&t.addClass("m--closed"),n=search.build.num_form(e.materials_number,{one:"материал",few:"материала",many:"материалов"}),i=e.materials_number>0?e.materials_number:"Нет",t.find(".__content").append("<b>"+i+"</b> "+n+"<br>"),n=search.build.num_form(e.tests_number,{one:"тест",few:"теста",many:"тестов"}),i=e.tests_number>0?e.tests_number:"Нет",t.find(".__content").append("<b>"+i+"</b> "+n),t},Search._.build.test=function(e){var t=$(search.template.test),n="",i="";return t.find(".__heading").text(e.title),t.find(".__content").html(""),n=search.build.num_form(e.questions_number,{one:"вопрос",few:"вопроса",many:"вопросов"}),i=e.questions_number>0?e.questions_number:"Нет",t.find(".__content").append("Тест, <b>"+i+"</b> "+n),t.find(".__content").append('<div class="m--grey">Из курса '+e.course_name+"</div>"),t},Search._.build.material=function(e){var t=$(search.template.material);return t.find(".__heading").text(e.title),t.find(".__content").append('<div class="m--grey">Из курса '+e.course_name+"</div>"),t},Search._.build.user=function(e){var t=$(search.template.user);return t.find(".__name").text(e.name),e.is_teacher?t.find(".__state").text("Преподаватель"):t.find(".__state").text("Ученик"),t.find(".__user-avatar").attr("src",e.avatar),t};var Search=function(e,t,n,i,s,r,a){var s=s||"Elements/Modules/UI/search/exports.html";this.$=$(loads[s]),this.url=window.location.pathname,this.is_shown=!1,this.show=function(){this.$.removeClass("m--hidden"),this.$.find("input").focus(),this.is_shown=!0},this.hide=function(){this.$.addClass("m--hidden"),this.is_shown=!1},this.types=t,this.types_active=i,this.request=function(){e(this).success(function(e){this.fill(e)}).fail(function(){notification.show("error","Не удалось подключиться к поиску")})},this.fill=function(e){Search._.fill(this,e)},this.filter=function(){Search._.filter(this)},this.templates=Search._.templates;for(var c in r)this.templates[c]=r[c];this.build=Search._.build;for(var c in a)this.build[c]=a[c];$("body").append(this.$),Search._.enable_query_listener(this),Search._.enable_checkbox_listener(this)};Search._={},Search._.fill=function(e,t){var n=e.$.find(".__links");n.html(""),t.length?(t.forEach(function(t){var i=$('<a class="m--card m--'+t.type+'" href="'+t.content.link+'"></a>');$new_item=e.build[t.type](t.content),i.append($new_item),n.append(i)}),e.filter()):n.append('<div class="m--empty m--grey">Ничего не найдено</div>')},Search._.filter=function(e){e.types.forEach(function(t){e.types_active.indexOf(t)===-1?e.$.find(".__links").children(".m--"+t).hide():e.$.find(".__links").children(".m--"+t).show()})};var search;!function(){var e=function(e){var t=e.$.find(".__query").val(),n={};e.types_active.indexOf("course")!==-1&&(n.courses={}),e.types_active.indexOf("user")!==-1&&(e.course_id?n.users={course_id:e.course_id}:n.users={});var i=e.types_active.indexOf("test")!==-1,s=e.types_active.indexOf("material")!==-1;return i&&s?n.elements={}:i?n.elements={type:"test"}:s&&(n.elements={type:"material"}),e.course_id&&n.elements&&(n.elements.course_id=e.course_id),$.ajax({url:"/func/search/",type:"POST",data:{csrfmiddlewaretoken:django.csrf_token,search_query:t,search_types:JSON.stringify(n)}})};$(document).ready(function(){search=new Search(e,["test","material","user","course"],["Тесты","Материалы","Пользователи","Открытые курсы"],["test","material"]),$(".header>.__search>button").click(function(){search.is_shown?search.hide():search.show()}),search.$.find(".m--close").click(function(e){search.hide()}),search.url.indexOf("course")>-1&&(exports.course_id="{{course.id}}")})}(),Search._.enable_query_listener=function(e){var t,n=500,i=e.$.find(".__query");i.keydown(function(){clearTimeout(t),t=setTimeout(function(){i.val();e.request()},n)})},Search._.enable_checkbox_listener=function(e){e.$.find('input[type="checkbox"]').each(function(t,n){var i=$(this).attr("class").slice(7);e.types_active.indexOf(i)>-1&&(this.checked=!0),$(this).change(function(){this.checked?(e.types_active.push(i),e.request()):(e.types_active.remove(i),e.filter())})})};