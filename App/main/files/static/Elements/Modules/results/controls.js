var results_controls={active_student:"",active_test:"",loaded:{tests:{},results:{}}};results_controls.check_load=function(){var t=results_controls.active_test,s=results_controls.active_student;return results_controls.loaded.tests[t+"-"+s]?results_controls.loaded.results[t+"-"+s]?{test:!0,results:!0}:{test:!0,results:!1}:{test:!1,results:!1}},results_controls.display=function(){show_active_test(results_controls.active_test);var t=results_controls.active_test,s=results_controls.active_student,e=t+"-"+s,r=results_controls.loaded.tests[e],o=results_controls.loaded.results[e].attempt,n=results_controls.loaded.results[e].mark;$(".preview>.__content").html(""),results_display.init(r,o,n);var c=$("<button>Сбросить результаты</button>");$(".preview").append(c),c.click(function(){$.ajax({url:"/test/reset_attempt/",type:"POST",data:{course_id:django.course.id,test_id:t,user_id:s,csrfmiddlewaretoken:django.csrf_token}}).success(function(t){t&&t.type?notification.show(t.type,t.message):notification.show("success","Результаты сброшены, ученик может переписать")}).error(function(t){notification.show("error","Произошла ошибка")})})},results_controls.load=function(){function t(){s.results.mark&&s.results.attempt?results_controls.display():setTimeout(t,20)}var s={results:!1},e=results_controls.active_test,r=results_controls.active_student;s.results={attempt:!1,mark:!1};var o;s.results.mark?(o=results_controls.loaded.results[e+"-"+r],s.results={attempt:!0,mark:!0}):(results_controls.loaded.results[e+"-"+r]={},results_controls.loaded.tests[e+"-"+r]={},$.ajax({url:"/test/get_test_info/",type:"POST",data:{csrfmiddlewaretoken:django.csrf_token,course_id:django.course.id,test_id:e,user_id:r,compiled:!0}}).success(function(t){s.results.test=!0,console.log(t),results_controls.loaded.tests[e+"-"+r]=t}),$.ajax({url:"/test/get_results/",type:"POST",data:{csrfmiddlewaretoken:django.csrf_token,course_id:django.course.id,test_id:e,user_id:r}}).success(function(t){s.results.mark=!0,results_controls.loaded.results[e+"-"+r].mark=t}),$.ajax({url:"/test/get_attempt_info/",type:"POST",data:{csrfmiddlewaretoken:django.csrf_token,course_id:django.course.id,test_id:e,user_id:r}}).success(function(t){s.results.attempt=!0,results_controls.loaded.results[e+"-"+r].attempt=t})),t()},results_controls.change_score_view=function(t,s,e,r,o){var n=function(t){t.removeClass("m--negative"),t.removeClass("m--neutral"),t.removeClass("m--positive")},c=results_display.calculate_score(),l=$('[href$="/'+results_controls.active_student+'"]').parent().find('button[test="'+results_controls.active_test+'"]'),a=$(".summary-item").eq(t).find("button"),u=$(".summary-mark");n(l),n(u),l.addClass("m--"+s.quality).text(s.value),results_display.update_mark(s,c),e===r?(summary.set_icon("right",o),summary.set_icon("right",a)):e>0?(summary.set_icon("forgiving",o),summary.set_icon("forgiving",a)):(summary.set_icon("wrong",o),summary.set_icon("wrong",a))},results_controls.send_mark=function(t,s,e,r){summary.set_icon("spinner",r),$.ajax({url:"/test/change_score/",type:"POST",data:{csrfmiddlewaretoken:django.csrf_token,course_id:django.course.id,test_id:results_controls.active_test,user_id:results_controls.active_student,answer_id:t,score:s}}).success(function(o){results_controls.change_score_view(t,o,s,e,r)}).error(function(t){notification.show("error",t)})},$(document).ready(function(){summary.add_icon("spinner",loads["Elements/Icons/spinner.svg"],"Сохраняем на сервере","m--neutral")}),results_controls.bind_stepper=function(t,s,e,r){var o=t.find(".inc_mark"),n=t.find(".dec_mark"),c=t.find(".__current");t.find(".__max").text(e),c.text(s),o.click(function(t){s<e&&(s++,c.text(s),r(s))}),n.click(function(t){s>0&&(s--,c.text(s),r(s))})},$(document).ready(function(){results_display.answer_decorator=function(t,s,e){var r=$(loads.get("Elements/Modules/Results/controls/__set_mark/")),o=t.find(".__icon");t.find(".__score").replaceWith(r);results_controls.bind_stepper(r,s.user_score,s.worth,function(t){results_controls.send_mark(e,t,s.worth,o)})}});