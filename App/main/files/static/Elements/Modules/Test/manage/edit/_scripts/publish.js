test_manager.publish=function(){var e=test_manager.fix_test_strict(editor.test_data);e&&popup.show(test_manager.publish_popup,function(){var t=test_manager.collect_publish();e.tasks.forEach(function(e){e.is_template&&(delete e.is_template,e.content=[],e.parts.forEach(function(t){e.content.push(generate.data.task.template.unwrap_replace(t,e.variables))}),delete e.variables,delete e.parts)}),delete e.templates;for(var i in e.groups)t.build.append(test_manager.render_inline(i,e.groups[i]));t.build.find(".__value").attr("disabled","disabled"),$("#random_build").change(function(){this.checked?(t.build.find(".__value").removeAttr("disabled"),$("#random_order").removeAttr("disabled")):(t.build.find(".__value").attr("disabled","disabled"),$("#random_order").attr("disabled","disabled"))});for(var a=test_manager.calculate_max_points(e),n=5;n>=2;n--)t.marks.append(test_manager.render_inline(n+" от",a));$("#course_section").change(function(){"Новая..."===this.value?$("#new_section_name").removeAttr("disabled"):$("#new_section_name").attr("disabled","disabled")}),$("#limit_time").change(function(){this.checked?t.time.find(".__value").removeAttr("disabled"):t.time.find(".__value").attr("disabled","disabled")}),$("#max_time").change(function(){(this.value<1||isNaN(this.value))&&(this.value=1)}),t.button.click(function(){test_manager.publish_parse(e)})},{width:"64rem"})},test_manager.publish_parse=function(e){var t=test_manager.collect_publish(),i=!0,a={random:{do:!1,shuffle:!1,limits:{}},forgive:{},max_score:test_manager.calculate_max_points(e),marks:{5:0,4:0,3:0,2:0},section:"Нераспределенные",time_limit:"00:00:00"};if($("#random_build").is(":checked")&&(a.random.do=!0,$("#random_order").is(":checked")&&(a.random.shuffle=!0),t.build.find(".row").each(function(){var e=$(this).find(".__group").text();e=e.substring(0,e.length-2);var t=parseInt($(this).find(".__value").val());t||(i=!1,notification.show("warning","Введите квоту для типа "+e)),a.random.limits[e]=parseInt(t)})),t.forgive.find("input").each(function(e,t){a.forgive[$(this).attr("id")]=this.checked}),t.marks.find("input").each(function(e,t){var n=5-e;a.marks[n.toString()]=parseInt(this.value),this.value||(i=!1,notification.show("warning","Введите минимальный балл для "+n))}),"Новая..."===$("#course_section").val()?a.section=$("#new_section_name").val():a.section=$("#course_section").val(),a.section||(notification.show("warning","Выберите секцию для размещения теста"),i=!1),$("#limit_time").is(":checked")){var n=parseInt($("#max_time").val());a.time_limit=[Math.floor(n/60),n%60,0].join(":"),a.time_limit=test_manager.expand_time(a.time_limit)}if(console.log(a),i){var s=new FormData;s.append("json_file",JSON.stringify(test_manager.packed_test)),s.append("course_id",django.course.id),defined(django.test.id)?s.append("test_id",django.test.id):s.append("material_id",django.material.id),s.append("csrfmiddlewaretoken",django.csrf_token),s.append("publish_data",JSON.stringify(a)),$.ajax({type:"POST",url:"/"+django.current_type+"/publish/",data:s,processData:!1,contentType:!1,success:function(e){notification.show(e.type,e.message),$("#"+django.current_type+"_publish").hide(),$("#"+django.current_type+"_unpublish").show(),popup.hide(),test_manager.save()},error:function(e){notification.show(e.type,e.message)}})}},test_manager.calculate_max_points=function(e){var t=0;return e.tasks.forEach(function(e){e.content.forEach(function(e){"answer"===e.type&&(t+=parseInt(e.worth))})}),t},test_manager.collect_publish=function(){var e={};return e.build=popup.$.find(".__build-settings"),e.forgive=popup.$.find(".__forgive"),e.marks=popup.$.find(".__mark-settings"),e.section=popup.$.find(".__course-section"),e.time=popup.$.find(".__time-settings"),e.button=popup.$.find("#publish"),e},test_manager.render_inline=function(e,t){console.log("rendering:",e,t);var i=$("<div class='row'><div class='__group'>"+e+": </div>"+loads.get("Elements/Inputs/text/inline/")+"<div class='__max'> / "+t+"</div></div>");return i.find("input").change(function(){var e=this.value;e=parseInt(e),console.log(e,t),(e<0||isNaN(e))&&(e=0),e>t&&(e=t),this.value=e}),i},test_manager.expand_time=function(e){for(var t=e.split(":"),i=0;i<t.length;i++)1==t[i].length&&(t[i]="0"+t[i]);return t.join(":")};