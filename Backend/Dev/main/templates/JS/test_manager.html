<script>
String.prototype.replaceAll = function(search, replacement) {
    var target = this;
    return target.replace(new RegExp(search, 'g'), replacement);
};

var csrf_token = '{{csrf_token}}';

var pack_input = {
	"block--empty" : function(){
		return {
			"class": "block--empty",
			"value": "none",
			"answer": "none"
		}	
	},
	"text-answer" : function(el){
		return {
			"class": "text-answer",
			"value": $(el).children('label').text(),
			"answer": $(el).attr('answer')
		}
	},
	"textarea" : function(el){
		return {
			"class": "textarea",
			"value": $(el).children('.textarea').children('label').text(),
			"answer": ""
		}
	},
	"file-answer" : function(el){
		return {"class": "file-answer"}
	},
	"select-answer": function(el){
		var values = [];
		$(el).find("option").each(function(index, el) {
			values.push($(this).text());
		});
		return {
			"class": "select-answer",
			"value": values,
			"answer": $(el).attr('answer')
		}
	}
}

var pack_question = {
	"text-wrapper" : function(el){
		return {
			"class": "text-wrapper",
			"value": $(el).html(),
		}
	},
	"image-wrapper" : function(el){
		return {
			"class": "image-wrapper",
			"value": $(el).children('img').attr("src"),
		}
	},
	"audio-wrapper" : function(el){
		return {
			"class": "audio-wrapper",
			"value": $(el).children('audio').attr("src"),
		}
	},
}

var test = {
	pack: function(){
		var testfile = {
			"title" : $(".test__heading").text(),
			"author": "{{teachername}}",
			"tasks" : []
		};
		$(".task__content").each(function(index, el) {
			var c_task = {
				"question_items": [],
				"answer_items" : []
			};
			$(this).children('.task__question').children().each(function(index, el) {
				var c_class = this.classList[0];
				// console.log(c_class)
				c_task.question_items.push(pack_question[c_class](this));
			});
			//answer shit need coplete revision
			$(this).children('.task__answer').children().each(function(index, el) {
				var c_class = this.classList[0];
				// console.log(c_class)
				c_task.answer_items.push(pack_input[c_class](this));
			});
			testfile.tasks.push(c_task);
		});
		console.log(testfile);
		var formData = new FormData();
		formData.append("json_file", JSON.stringify(testfile));
		formData.append("test_id", "{{test.id}}");
		// console.log(csrf_token, "{{test.id}}", "{{course.id}}");
		formData.append('csrfmiddlewaretoken', csrf_token);
		// console.log(formData);
		$.ajax({
			type:"POST",
			url:"../save/",
			data: formData,
			processData: false,
			contentType: false,
			success: function(data){
				notification.change('success', 'success', data);
			}
		});
	},
	unpack: function(testfile) {
		testfile = JSON.parse(testfile.replaceAll('&quot;', '"'));
		$(".test__heading, title").text(testfile.title);
		testfile.tasks.forEach(function(task_data){
			generate.task(task_data);
		});
		$("input").each(function(index, el) {
			add_emptiness_checker(this);
		});
		$(".audio-wrapper").each(function(index, el) {
	        media_player.bind_controls(this);
	    });
	}
}

$(document).ready(function() {
	$("#test_save").click(function(event) {
		test.pack();
	});

	$("#test_publish").click(function(event) {
		test.pack();
		var formData = new FormData();
		formData.append("test_id", "{{test.id}}");
		formData.append('csrfmiddlewaretoken', csrf_token);
		$.ajax({
			type:"POST",
			url:"../publish/",
			data: formData,
			processData: false,
			contentType: false,
			success: function(data){
				notification.change('success','success', data);
			}
		});
		$("#test_publish").hide();
		$("#test_unpublish").show();
	});

	$("#test_unpublish").click(function(event) {
		test.pack();
		var formData = new FormData();
		formData.append("test_id", "{{test.id}}");
		formData.append('csrfmiddlewaretoken', csrf_token);
		$.ajax({
			type:"POST",
			url:"../unpublish/",
			data: formData,
			processData: false,
			contentType: false,
			success: function(data){
				notification.change('success','success', data);
			}
		});
		$("#test_publish").show();
		$("#test_unpublish").hide();
	});

	{% if test.loaded %}
		test.unpack('{{test.json}}');
	{% endif %}
});</script>